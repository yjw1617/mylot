#include "mySys.h"
//////////////////////////////////////////////////////////////////////////////////	 
//???????????????¦Ä????????????????????????¦Ê????
//ALIENTEK STM32F407??????
//?????????	
//???????????/?§Ø????/GPIO?????
//???????@ALIENTEK
//???????:www.openedv.com
//????????:2017/4/6
//?·Ú??V1.0
//??????§µ?????????
//Copyright(C) ?????????????????????? 2014-2024
//All rights reserved
//********************************************************************************
//??????
//??
////////////////////////////////////////////////////////////////////////////////// 

//????????¨²???
//Fvco=Fs*(plln/pllm);
//SYSCLK=Fvco/pllp=Fs*(plln/(pllm*pllp));
//Fusb=Fvco/pllq=Fs*(plln/(pllm*pllq));

//Fvco:VCO???
//SYSCLK:????????
//Fusb:USB,SDIO,RNG?????????
//Fs:PLL??????????,??????HSI,HSE??. 
//plln:??PLL??????(PLL???),????¦¶:64~432.
//pllm:??PLL?????PLL??????(PLL??????),????¦¶:2~63.
//pllp:????????PLL??????(PLL??????),????¦¶:2,4,6,8.(??????4???!)
//pllq:USB/SDIO/????????????????PLL??????(PLL??????),????¦¶:2~15.

//???????8M?????,????:plln=336,pllm=8,pllp=2,pllq=7.
//???:Fvco=8*(336/8)=336Mhz
//     SYSCLK=336/2=168Mhz
//     Fusb=336/7=48Mhz
//?????:0,???;1,???
void Stm32_Clock_Init(u32 plln,u32 pllm,u32 pllp,u32 pllq)
{
    HAL_StatusTypeDef ret = HAL_OK;
    RCC_OscInitTypeDef RCC_OscInitStructure; 
    RCC_ClkInitTypeDef RCC_ClkInitStructure;
    
    __HAL_RCC_PWR_CLK_ENABLE(); //???PWR???
    
    //??????????????????????????????????????????¦Ä???????????
    //????????????????
    __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);//??????????????????1
    
    RCC_OscInitStructure.OscillatorType=RCC_OSCILLATORTYPE_HSE;    //?????HSE
    RCC_OscInitStructure.HSEState=RCC_HSE_ON;                      //??HSE
    RCC_OscInitStructure.PLL.PLLState=RCC_PLL_ON;//??PLL
    RCC_OscInitStructure.PLL.PLLSource=RCC_PLLSOURCE_HSE;//PLL???????HSE
    RCC_OscInitStructure.PLL.PLLM=pllm; //??PLL?????PLL??????(PLL??????),????¦¶:2~63.
    RCC_OscInitStructure.PLL.PLLN=plln; //??PLL??????(PLL???),????¦¶:64~432.  
    RCC_OscInitStructure.PLL.PLLP=pllp; //????????PLL??????(PLL??????),????¦¶:2,4,6,8.(??????4???!)
    RCC_OscInitStructure.PLL.PLLQ=pllq; //USB/SDIO/????????????????PLL??????(PLL??????),????¦¶:2~15.
    ret=HAL_RCC_OscConfig(&RCC_OscInitStructure);//?????
	
    if(ret!=HAL_OK) while(1);
    
    //???PLL?????????????????HCLK,PCLK1??PCLK2
    RCC_ClkInitStructure.ClockType=(RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2);
    RCC_ClkInitStructure.SYSCLKSource=RCC_SYSCLKSOURCE_PLLCLK;//??????????????PLL
    RCC_ClkInitStructure.AHBCLKDivider=RCC_SYSCLK_DIV1;//AHB???????1
    RCC_ClkInitStructure.APB1CLKDivider=RCC_HCLK_DIV4; //APB1???????4
    RCC_ClkInitStructure.APB2CLKDivider=RCC_HCLK_DIV2; //APB2???????2
    ret=HAL_RCC_ClockConfig(&RCC_ClkInitStructure,FLASH_LATENCY_5);//??????FLASH????????5WS???????6??CPU?????
		
    if(ret!=HAL_OK) while(1);

	 //STM32F405x/407x/415x/417x Z?·Ú???????????????
	if (HAL_GetREVID() == 0x1001)
	{
		__HAL_FLASH_PREFETCH_BUFFER_ENABLE();  //???flash??
	}
}

#ifdef  USE_FULL_ASSERT
//?????????????????????????????????????????????
//file?????????
//line???????????§Ö?????
void assert_failed(uint8_t* file, uint32_t line)
{ 
	while (1)
	{
	}
}
#endif

//THUMB????????????
//???????¡¤????????§Ý?????WFI  
__asm void WFI_SET(void)
{
	WFI;		  
}
//????????§Ø?(?????????fault??NMI?§Ø?)
__asm void INTX_DISABLE(void)
{
	CPSID   I
	BX      LR	  
}
//?????????§Ø?
__asm void INTX_ENABLE(void)
{
	CPSIE   I
	BX      LR  
}
//??????????
//addr:??????
__asm void MSR_MSP(u32 addr) 
{
	MSR MSP, r0 			//set Main Stack value
	BX r14
}
